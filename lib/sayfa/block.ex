defmodule Sayfa.Block do
  @moduledoc """
  Registry and lookup functions for blocks.

  Maps block names to block modules. By default, sixteen built-in blocks
  are registered. Custom blocks can be added via application config:

      config :sayfa, :blocks, [MyApp.Blocks.Banner | Sayfa.Block.default_blocks()]

  ## Block Helper

  The `build_helper/1` function creates a closure that templates use as `@block`:

      block_fn = Sayfa.Block.build_helper(site: config, content: content, contents: all_contents, lang: :en)
      block_fn.(:hero, title: "Welcome")
      #=> "<section class=\\"hero\\">..."

  ## Examples

      iex> length(Sayfa.Block.default_blocks())
      16

      iex> Sayfa.Block.find_by_name(:hero)
      Sayfa.Blocks.Hero

      iex> Sayfa.Block.find_by_name(:nonexistent)
      nil

  """

  @doc """
  Returns the list of built-in block modules.

  ## Examples

      iex> length(Sayfa.Block.default_blocks())
      16

  """
  @spec default_blocks() :: [module()]
  def default_blocks do
    [
      Sayfa.Blocks.Hero,
      Sayfa.Blocks.Header,
      Sayfa.Blocks.Footer,
      Sayfa.Blocks.SocialLinks,
      Sayfa.Blocks.TOC,
      Sayfa.Blocks.RecentPosts,
      Sayfa.Blocks.TagCloud,
      Sayfa.Blocks.CategoryCloud,
      Sayfa.Blocks.ReadingTime,
      Sayfa.Blocks.CodeCopy,
      Sayfa.Blocks.RecentContent,
      Sayfa.Blocks.Search,
      Sayfa.Blocks.CopyLink,
      Sayfa.Blocks.Breadcrumb,
      Sayfa.Blocks.LanguageSwitcher,
      Sayfa.Blocks.RelatedPosts
    ]
  end

  @doc """
  Returns all registered block modules.

  Reads from application config, falling back to `default_blocks/0`.

  ## Examples

      iex> blocks = Sayfa.Block.all()
      iex> is_list(blocks)
      true

  """
  @spec all() :: [module()]
  def all do
    Application.get_env(:sayfa, :blocks, default_blocks())
  end

  @doc """
  Finds a block module by its atom name.

  ## Examples

      iex> Sayfa.Block.find_by_name(:hero)
      Sayfa.Blocks.Hero

      iex> Sayfa.Block.find_by_name(:nonexistent)
      nil

  """
  @spec find_by_name(atom()) :: module() | nil
  def find_by_name(name) do
    Enum.find(all(), fn mod -> mod.name() == name end)
  end

  @doc """
  Builds the `@block` helper function for templates.

  Takes a keyword list of context and returns a function that looks up
  a block by name, merges the context with caller options, and calls `render/1`.

  ## Context Keys

  - `:site` — resolved config map
  - `:content` — current `Sayfa.Content` struct (may be `nil`)
  - `:contents` — list of all site contents
  - `:lang` — current language atom
  - `:t` — translation function `(String.t() -> String.t())`

  ## Examples

      block_fn = Sayfa.Block.build_helper(site: config, content: content, contents: [], lang: :en)
      block_fn.(:hero, title: "Welcome")
      #=> "<section class=\\"hero\\">..."

      block_fn.(:nonexistent, [])
      #=> ""

  """
  @spec build_helper(keyword()) :: (atom(), keyword() -> String.t())
  def build_helper(context) do
    ctx_map = Map.new(context)

    fn name, opts ->
      case find_by_name(name) do
        nil ->
          ""

        mod ->
          assigns = Map.merge(ctx_map, Map.new(opts))
          mod.render(assigns)
      end
    end
  end

  @doc """
  Escapes HTML special characters in a string.

  ## Examples

      iex> Sayfa.Block.escape_html("<script>alert('xss')</script>")
      "&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;"

      iex> Sayfa.Block.escape_html("Hello & World")
      "Hello &amp; World"

  """
  @spec escape_html(String.t()) :: String.t()
  def escape_html(text) when is_binary(text) do
    text
    |> String.replace("&", "&amp;")
    |> String.replace("<", "&lt;")
    |> String.replace(">", "&gt;")
    |> String.replace("\"", "&quot;")
    |> String.replace("'", "&#39;")
  end

  def escape_html(nil), do: ""

  # SVG path data for brand icons (filled style)
  @social_icon_paths %{
    "github" =>
      ~s(M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12),
    "twitter" =>
      ~s(M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z),
    "mastodon" =>
      ~s(M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.5 4.5 0 0 1-.04-.621s1.77.432 4.014.535c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.41 2.405 1.228l.518.869.519-.869c.533-.818 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558z),
    "goodreads" =>
      ~s(M17.346.026c.422-.083.859.037 1.179.325.346.284.55.705.557 1.153-.023.457-.247.88-.612 1.156l-2.182 1.748a.601.601 0 0 0-.255.43.52.52 0 0 0 .11.424 5.886 5.886 0 0 1 .832 6.58c-1.394 2.79-4.503 3.99-7.501 2.927a.792.792 0 0 0-.499-.01c-.224.07-.303.18-.453.383l-.014.02-.941 1.254s-.792.985.457.935c3.027-.119 3.817-.119 5.439-.01 2.641.18 3.806 1.903 3.806 3.275 0 1.623-1.036 3.383-3.809 3.383a117.46 117.46 0 0 0-5.517-.03c-.31.005-.597.013-.835.02-.228.006-.41.011-.52.011-.712 0-1.648-.186-1.66-1.068-.008-.729.624-1.12 1.11-1.172.43-.045.815.007 1.24.064.252.034.518.07.815.088.185.011.366.025.552.038.53.038 1.102.08 1.926.087.427.005.759.01 1.025.015.695.012.941.016 1.28-.015 1.248-.112 1.832-.61 1.832-1.376 0-.805-.584-1.264-1.698-1.414-1.564-.213-2.33-.163-3.72-.074a87.66 87.66 0 0 1-1.669.095c-.608.029-2.449.026-2.682-1.492-.053-.416-.073-1.116.807-2.325l.75-1.003c.36-.49.582-.898.053-1.559 0 0-.39-.468-.52-.638-1.215-1.587-1.512-4.08-.448-6.114 1.577-3.011 5.4-4.26 8.37-2.581.253.143.438.203.655.163.201-.032.27-.167.363-.344.02-.04.042-.082.067-.126.004-.01.241-.465.535-1.028l.734-1.41a1.493 1.493 0 0 1 1.041-.785ZM9.193 13.243c1.854.903 3.912.208 5.254-2.47 1.352-2.699.827-5.11-1.041-6.023C10.918 3.537 8.81 5.831 8.017 7.41c-1.355 2.698-.717 4.886 1.147 5.818Z),
    "linkedin" =>
      ~s(M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z),
    "youtube" =>
      ~s(M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z),
    "instagram" =>
      ~s(M7.0301.084c-1.2768.0602-2.1487.264-2.911.5634-.7888.3075-1.4575.72-2.1228 1.3877-.6652.6677-1.075 1.3368-1.3802 2.127-.2954.7638-.4956 1.6365-.552 2.914-.0564 1.2775-.0689 1.6882-.0626 4.947.0062 3.2586.0206 3.6671.0825 4.9473.061 1.2765.264 2.1482.5635 2.9107.308.7889.72 1.4573 1.388 2.1228.6679.6655 1.3365 1.0743 2.1285 1.38.7632.295 1.6361.4961 2.9134.552 1.2773.056 1.6884.069 4.9462.0627 3.2578-.0062 3.668-.0207 4.9478-.0814 1.28-.0607 2.147-.2652 2.9098-.5633.7889-.3086 1.4578-.72 2.1228-1.3881.665-.6682 1.0745-1.3378 1.3795-2.1284.2957-.7632.4966-1.636.552-2.9124.056-1.2809.0692-1.6898.063-4.948-.0063-3.2583-.021-3.6668-.0817-4.9465-.0607-1.2797-.264-2.1487-.5633-2.9117-.3084-.7889-.72-1.4568-1.3876-2.1228C21.2982 1.33 20.628.9208 19.8378.6165 19.074.321 18.2017.1197 16.9244.0645 15.6471.0093 15.236-.005 11.977.0014 8.718.0076 8.31.0215 7.0301.0839m.1402 21.6932c-1.17-.0509-1.8053-.2453-2.2287-.408-.5606-.216-.96-.4771-1.3819-.895-.422-.4178-.6811-.8186-.8981-1.3783-.1644-.4234-.3624-1.058-.4171-2.228-.0595-1.2645-.072-1.6442-.079-4.848-.007-3.2037.0053-3.583.0607-4.848.05-1.169.2456-1.805.408-2.2282.216-.5613.4762-.96.895-1.3816.4188-.4217.8184-.6814 1.3783-.8988.4227-.1649 1.0557-.3633 2.227-.4171 1.2655-.06 1.6447-.072 4.848-.079 3.2033-.007 3.5835.005 4.8495.0608 1.169.0508 1.8053.2445 2.228.408.5608.216.96.4754 1.3816.895.4217.4194.6816.8176.8988 1.3783.1645.4217.3633 1.0551.4171 2.2246.0605 1.2645.0722 1.6443.079 4.848.0069 3.2033-.006 3.5834-.061 4.848-.051 1.17-.245 1.8055-.408 2.2294-.216.5604-.4763.96-.8954 1.3814-.419.4215-.8181.6811-1.3783.8985-.4227.1644-1.0557.3624-2.2271.4171-1.2652.0595-1.6446.072-4.8479.079-3.2033.0069-3.5832-.0053-4.8484-.0608M16.953 5.5864A1.44 1.44 0 1 0 18.39 4.144a1.44 1.44 0 0 0-1.437 1.4424M5.8385 12.012c.0067 3.4032 2.7706 6.1557 6.173 6.1493 3.4026-.0065 6.157-2.7701 6.1506-6.1733-.0065-3.4032-2.771-6.1565-6.174-6.1498-3.403.0067-6.156 2.771-6.1496 6.1738M8 12.0077a4 4 0 1 1 4.008 3.9921A3.9996 3.9996 0 0 1 8 12.0077),
    "bluesky" =>
      ~s(M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.785 2.63 3.651 3.504 6.295 3.194-4.476.655-8.429 2.242-3.066 7.932C8.684 25.753 11.16 19.95 12 17.6c.84 2.35 2.48 7.463 8.147 3.773 5.363-5.69 1.41-7.277-3.066-7.932 2.644.31 5.51-.565 6.295-3.194.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8),
    "threads" =>
      ~s(M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.96-.065-1.19.408-2.285 1.33-3.082.88-.76 2.112-1.201 3.574-1.282 1.07-.059 2.065.043 2.96.293-.075-.69-.291-1.221-.651-1.585-.462-.468-1.194-.708-2.173-.738H12c-1.104 0-2.542.292-3.283 1.379l-1.734-1.088C7.986 5.673 9.776 5.2 12.011 5.2h.075c1.394.042 2.543.44 3.416 1.186.798.681 1.322 1.61 1.574 2.756.62.177 1.185.414 1.694.709 1.229.711 2.142 1.713 2.641 2.898.76 1.81.756 4.537-1.351 6.6-1.826 1.787-4.06 2.605-7.238 2.645l-.004.006zm-.636-5.478c.78-.045 1.394-.31 1.83-.787.3-.329.53-.753.694-1.275-.65-.176-1.365-.264-2.14-.222-1.218.067-2.14.523-2.104 1.42.018.448.387 1.152 1.72.864z),
    "discord" =>
      ~s(M20.317 4.3698a19.7913 19.7913 0 0 0-4.8851-1.5152.0741.0741 0 0 0-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 0 0-.0785-.037 19.7363 19.7363 0 0 0-4.8852 1.515.0699.0699 0 0 0-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 0 0 .0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 0 0 .0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 0 0-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 0 1-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 0 1 .0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 0 1 .0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 0 1-.0066.1276 12.2986 12.2986 0 0 1-1.8732.8914.0766.0766 0 0 0-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 0 0 .0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 0 0 .0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 0 0-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189z),
    "reddit" =>
      ~s(M12 0C5.373 0 0 5.373 0 12c0 3.314 1.343 6.314 3.515 8.485l-2.286 2.286C.775 23.225 1.097 24 1.738 24H12c6.627 0 12-5.373 12-12S18.627 0 12 0zm4.388 3.199c1.104 0 1.999.895 1.999 1.999 0 1.105-.895 2-1.999 2-.946 0-1.739-.657-1.947-1.539-1.147.162-2.032 1.15-2.032 2.341v.246c1.332.078 2.569.374 3.632.839.36-.318.826-.513 1.342-.513 1.105 0 2.001.896 2.001 2.001a2 2 0 0 1-.869 1.652c.035.221.054.446.054.674 0 3.292-3.737 5.961-8.344 5.961-4.608 0-8.345-2.669-8.345-5.961 0-.214.017-.425.049-.633a2 2 0 0 1-.896-1.669c0-1.105.896-2.001 2.001-2.001.493 0 .945.178 1.293.474 1.073-.479 2.327-.784 3.677-.862l.601-4.207a.5.5 0 0 1 .588-.427l3.104.545c.264-.635.895-1.079 1.629-1.079l-.002-.003zm-8.163 8.46c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm7.563 0c-1.105 0-2.001.896-2.001 2s.896 2 2.001 2c1.104 0 2-.896 2-2s-.896-2-2-2zm-7.065 5.992a.5.5 0 0 1 .67-.226 5.342 5.342 0 0 0 4.835.058.5.5 0 0 1 .448.893 6.336 6.336 0 0 1-5.735-.054.5.5 0 0 1-.218-.671z),
    "stackoverflow" =>
      ~s(M15.725 0l-1.72 1.277 6.39 8.588 1.716-1.277L15.725 0zm-3.94 3.418l-1.369 1.644 8.225 6.85 1.369-1.644-8.225-6.85zm-3.15 4.465l-.905 1.94 9.702 4.517.904-1.94-9.701-4.517zm-1.85 4.86l-.44 2.093 10.473 2.201.44-2.092-10.473-2.203zM1.89 15.47V24h19.19v-8.53h-2.133v6.397H4.021v-6.396H1.89zm4.265 2.133v2.13h10.66v-2.13H6.154z),
    "facebook" =>
      ~s(M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 1.09.044 1.613.115V0h-.916c-3.164 0-4.144 2.936-4.144 5.307v2.158h7.744l-.516 3.667h-7.228v8.559h4.976c5.501-.032 9.512-4.506 9.512-10.558C24 4.604 18.627 0 12 0S0 4.604 0 11.133c0 5.683 3.501 10.019 8.477 11.024l.624-.466z),
    "medium" =>
      ~s(M13.54 12a6.8 6.8 0 0 1-6.77 6.82A6.8 6.8 0 0 1 0 12a6.8 6.8 0 0 1 6.77-6.82A6.8 6.8 0 0 1 13.54 12zM20.96 12c0 3.54-1.51 6.42-3.38 6.42-1.87 0-3.39-2.88-3.39-6.42s1.52-6.42 3.39-6.42 3.38 2.88 3.38 6.42M24 12c0 3.17-.53 5.75-1.19 5.75-.66 0-1.19-2.58-1.19-5.75s.53-5.75 1.19-5.75C23.47 6.25 24 8.83 24 12z),
    "dev.to" =>
      ~s(M7.42 10.05c-.18-.16-.46-.23-.84-.23H6v4.36h.58c.37 0 .67-.08.84-.23.2-.17.31-.47.31-.95v-2c0-.49-.12-.78-.31-.95m12.57-1.05C18.44 7.56 16.29 6 13.76 6H3.38A2.38 2.38 0 0 0 1 8.38v7.25A2.38 2.38 0 0 0 3.38 18h10.38c2.53 0 4.68-1.56 5.63-3.95A8.95 8.95 0 0 0 20 12c0-.76-.08-1.51-.23-2.24.15-.72.23-1.46.23-2.21 0-.55-.08-1.09-.21-1.55zM8.82 14.25c0 .97-.53 1.87-1.57 2.21H4.8V7.54h2.45c1.04.34 1.57 1.24 1.57 2.21v4.5zm4.56-.88c0 .64-.46 1.07-1.07 1.07-.6 0-1.07-.43-1.07-1.07v-.63c0-.64.46-1.07 1.07-1.07.6 0 1.07.43 1.07 1.07v.63zm.06-2.58c0 .64-.46 1.07-1.07 1.07-.6 0-1.07-.43-1.07-1.07v-.63c0-.64.46-1.07 1.07-1.07.6 0 1.07.43 1.07 1.07v.63zm4.56 4.91c-.47.35-1.31.28-1.68-.12l-1.42-2.5v2.46h-1.7V7.54h1.7v2.46l1.42-2.5c.37-.41 1.21-.47 1.68-.12.24.18.36.42.36.68 0 .2-.06.4-.18.57L15.8 10.5l2.08 1.87c.12.17.18.37.18.57 0 .26-.12.5-.36.68z),
    "telegram" =>
      ~s(M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z),
    "kofi" =>
      ~s(M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604 0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407 0 0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z),
    "codeberg" =>
      ~s(M11.955.49A12 12 0 0 0 0 12.49a12 12 0 0 0 1.832 6.373L11.838 5.928a.187.187 0 0 1 .324 0l10.006 12.935A12 12 0 0 0 24 12.49a12 12 0 0 0-12-12 12 12 0 0 0-.045 0zm.375 6.467 4.416 16.553a12 12 0 0 0 5.137-4.213z),
    "letterboxd" =>
      ~s(M8.224 14.352a4.773 4.773 0 0 1-1.103-3.065c0-1.168.418-2.24 1.113-3.07A4.77 4.77 0 0 0 6.627 12c0 .96.281 1.853.767 2.602l.006-.01.824-1.24v1zm3.55 2.138A4.773 4.773 0 0 1 7.272 12a4.773 4.773 0 0 1 1.677-3.641l-1.4-.836A7.272 7.272 0 0 0 4.77 12c0 1.794.647 3.437 1.722 4.707l.836-.836zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 1.5c4.687 0 8.5 3.813 8.5 8.5s-3.813 8.5-8.5 8.5S3.5 16.687 3.5 12 7.313 3.5 12 3.5zm-.226 5.348a4.773 4.773 0 0 1 0 6.304l.226.348.226-.348a4.773 4.773 0 0 1 0-6.304L12 8.5l-.226.348zm.45-.348a4.773 4.773 0 0 1 1.103 3.065c0 1.168-.418 2.24-1.113 3.07A4.77 4.77 0 0 0 13.82 12a4.77 4.77 0 0 0-.767-2.602l-.006.01-.823 1.24v-1zM12.226 5.51a4.773 4.773 0 0 1 4.502 4.49 4.773 4.773 0 0 1-1.677 3.641l1.4.836A7.272 7.272 0 0 0 19.23 12c0-1.794-.647-3.437-1.722-4.707l-.836.836z),
    "spotify" =>
      ~s(M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z),
    "hackernews" =>
      ~s(M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z),
    "twitch" =>
      ~s(M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714z)
  }

  # Label aliases → canonical key in @social_icon_paths
  @social_label_aliases %{
    "x" => "twitter",
    "x / twitter" => "twitter",
    "linked in" => "linkedin",
    "yt" => "youtube",
    "ig" => "instagram",
    "bsky" => "bluesky",
    "stack overflow" => "stackoverflow",
    "so" => "stackoverflow",
    "fb" => "facebook",
    "devto" => "dev.to",
    "dev" => "dev.to",
    "tg" => "telegram",
    "ko-fi" => "kofi",
    "hacker news" => "hackernews",
    "hn" => "hackernews"
  }

  @doc """
  Returns an SVG icon for the given social platform label.

  Supports 24 platforms with filled brand icons (`fill="currentColor"`):
  GitHub, X/Twitter, Mastodon, Goodreads, LinkedIn, YouTube, Instagram,
  Bluesky, Threads, Discord, Reddit, Stack Overflow, Facebook, Medium,
  Dev.to, Telegram, Ko-fi, Codeberg, Letterboxd, Spotify, Hacker News,
  and Twitch.

  Utility icons (Email, RSS/Feed) use outlined style. Unknown platforms
  get a generic link icon fallback.

  Labels are case-insensitive and support aliases (e.g., `"yt"` for YouTube,
  `"bsky"` for Bluesky, `"so"` for Stack Overflow).

  ## Examples

      iex> Sayfa.Block.social_icon("github", "w-4 h-4") |> String.contains?("svg")
      true

      iex> Sayfa.Block.social_icon("unknown", "w-5 h-5") |> String.contains?("svg")
      true

  """
  @spec social_icon(String.t(), String.t()) :: String.t()
  def social_icon(label, size \\ "w-5 h-5") do
    normalized = String.downcase(label)
    key = Map.get(@social_label_aliases, normalized, normalized)

    case Map.get(@social_icon_paths, key) do
      nil ->
        outlined_icon(normalized, size)

      path ->
        ~s(<svg class="#{size}" fill="currentColor" stroke="none" viewBox="0 0 24 24" aria-hidden="true"><path d="#{path}"/></svg>)
    end
  end

  defp outlined_icon(label, size) do
    case label do
      "email" ->
        ~s(<svg class="#{size}" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>)

      x when x in ["rss", "feed"] ->
        ~s(<svg class="#{size}" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>)

      _ ->
        ~s(<svg class="#{size}" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>)
    end
  end

  @doc """
  Returns the `rel` attribute for a social link.

  Returns `"me noopener"` for Mastodon links and `"noopener"` for all others.

  ## Examples

      iex> Sayfa.Block.social_rel("Mastodon")
      "me noopener"

      iex> Sayfa.Block.social_rel("GitHub")
      "noopener"

  """
  @spec social_rel(String.t()) :: String.t()
  def social_rel(label) do
    if String.contains?(String.downcase(label), "mastodon"),
      do: "me noopener",
      else: "noopener"
  end
end
